import{F as I,L as N,U as F,b as z,P as H,W as Ae,I as Ie}from"./I3DMLoader-Co8j1K3i.js";import{g as De,r as Oe}from"./BatchTable-CRr3zuRk.js";import{B as Ve}from"./B3DMLoader-D_8ejTd0.js";import{P as Ne}from"./PNTSLoader-C47qgwy1.js";import{C as ze}from"./CMPTLoader-CdR2x6K5.js";import{G as _e,l as k,ae as ge,m as y,B as je,at as qe,d as We,bj as Qe,aS as Ge,T as Je,b8 as $e,aQ as j,V as be,aO as He}from"./three.module-DBfedTbk.js";import{E as Ye}from"./EllipsoidRegion-By3sIuka.js";import{e as Xe,G as Ze}from"./GLTFLoader-BjagHNWe.js";function oe(i){if(!i)return null;let e=i.length;const t=i.indexOf("?"),s=i.indexOf("#");t!==-1&&(e=Math.min(e,t)),s!==-1&&(e=Math.min(e,s));const n=i.lastIndexOf(".",e),r=i.lastIndexOf("/",e),o=i.indexOf("://");return o!==-1&&o+2===r||n===-1||n<r?null:i.substring(n+1,e)||null}const ae=2**30;class Ke{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){e.length===1?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,s)=>{const n=e(t),r=e(s);return n<r?-1:n>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=.3*ae,this.maxBytesSize=.4*ae,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)||0}setMemoryUsage(e,t){const{bytesMap:s,itemSet:n}=this;n.has(e)&&(this.cachedBytes-=s.get(e)||0,s.set(e,t),this.cachedBytes+=t)}add(e,t){const s=this.itemSet;if(s.has(e)||this.isFull())return!1;const n=this.usedSet,r=this.itemList,o=this.callbacks;return r.push(e),n.add(e),s.set(e,Date.now()),o.set(e,t),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,s=this.itemSet,n=this.itemList,r=this.bytesMap,o=this.callbacks,a=this.loadedSet;if(s.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),o.get(e)(e);const l=n.indexOf(e);return n.splice(l,1),t.delete(e),s.delete(e),o.delete(e),a.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:s,loadedSet:n}=this;s.has(e)&&(t===!0?n.add(e):n.delete(e))}markUsed(e){const t=this.itemSet,s=this.usedSet;t.has(e)&&!s.has(e)&&(t.set(e,Date.now()),s.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:s,itemList:n,itemSet:r,usedSet:o,loadedSet:a,callbacks:l,bytesMap:h,minBytesSize:c,maxBytesSize:p}=this,f=n.length-o.size,d=n.length-a.size,_=Math.max(Math.min(n.length-t,f),0),m=this.cachedBytes-c,b=this.unloadPriorityCallback||this.defaultPriorityCallback;let P=!1;const L=_>0&&f>0||d&&n.length>s;if(f&&this.cachedBytes>c||d&&this.cachedBytes>p||L){n.sort((g,C)=>{const ie=o.has(g),Be=o.has(C);if(ie===Be){const re=a.has(g),Ee=a.has(C);return re===Ee?-b(g,C):re?1:-1}else return ie?1:-1});const u=Math.max(t*e,_*e),T=Math.ceil(Math.min(u,f,_)),x=Math.max(e*m,e*c),w=Math.min(x,m);let S=0,E=0;for(;this.cachedBytes-E>p||n.length-S>s;){const g=n[S],C=h.get(g)||0;if(o.has(g)&&a.has(g)||this.cachedBytes-E-C<p&&n.length-S<=s)break;E+=C,S++}for(;E<w||S<T;){const g=n[S],C=h.get(g)||0;if(o.has(g)||this.cachedBytes-E-C<c&&S>=T)break;E+=C,S++}n.splice(0,S).forEach(g=>{this.cachedBytes-=h.get(g)||0,l.get(g)(g),h.delete(g),r.delete(g),l.delete(g),a.delete(g),o.delete(g)}),P=S<_||E<m&&S<f,P=P&&S>0}P&&(this.unloadingHandle=requestAnimationFrame(()=>this.scheduleUnload()))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask(()=>{this.scheduled=!1,this.unloadUnusedContent()}))}}class Y{get running(){return this.items.length!==0||this.currJobs!==0}constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=null,this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.scheduled=!1,this.tryRunJobs()}}sort(){const e=this.priorityCallback,t=this.items;e!==null&&t.sort(e)}has(e){return this.callbacks.has(e)}add(e,t){const s={callback:t,reject:null,resolve:null,promise:null};return s.promise=new Promise((n,r)=>{const o=this.items,a=this.callbacks;s.resolve=n,s.reject=r,o.unshift(e),a.set(e,s),this.autoUpdate&&this.scheduleJobRun()}),s.promise}remove(e){const t=this.items,s=this.callbacks,n=t.indexOf(e);if(n!==-1){const r=s.get(e);r.promise.catch(()=>{}),r.reject(new Error("PriorityQueue: Item removed.")),t.splice(n,1),s.delete(e)}}removeByFilter(e){const{items:t}=this;for(let s=0;s<t.length;s++){const n=t[s];e(n)&&this.remove(n)}}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,s=this.maxJobs;let n=0;const r=()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()};for(;s>this.currJobs&&e.length>0&&n<s;){this.currJobs++,n++;const o=e.pop(),{callback:a,resolve:l,reject:h}=t.get(o);t.delete(o);let c;try{c=a(o)}catch(p){h(p),r()}c instanceof Promise?c.then(l).catch(h).finally(r):(l(c),r())}}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const q={inView:!1,error:1/0,distanceFromCamera:1/0},ye=!0;function Te(i){return i===N||i===I}function B(i,e){return i.__lastFrameVisited===e&&i.__used}function te(i){return i.__childrenProcessed===i.children.length}function se(i){return i.__hasUnrenderableContent||i.parent&&i.parent.geometricError<i.geometricError}function ne(i,e){i.__lastFrameVisited!==e.frameCount&&(i.__lastFrameVisited=e.frameCount,i.__used=!1,i.__inFrustum=!1,i.__isLeaf=!1,i.__visible=!1,i.__active=!1,i.__error=1/0,i.__distanceFromCamera=1/0,i.__allChildrenReady=!1,e.calculateTileViewError(i,q),i.__inFrustum=q.inView,i.__error=q.error,i.__distanceFromCamera=q.distanceFromCamera)}function K(i,e,t=!1){if(e.ensureChildrenArePreprocessed(i),ne(i,e),ee(i,e,t),se(i)&&te(i)){const s=i.children;for(let n=0,r=s.length;n<r;n++)K(s[n],e,t)}}function ve(i,e){if(e.ensureChildrenArePreprocessed(i),B(i,e.frameCount)&&(i.__hasContent&&e.queueTileForDownload(i),te(i))){const t=i.children;for(let s=0,n=t.length;s<n;s++)ve(t[s],e)}}function ee(i,e,t=!1){i.__used||(t||(i.__used=!0,e.stats.used++),e.markTileUsed(i),i.__inFrustum===!0&&e.stats.inFrustum++)}function et(i,e){return!(i.__error<=e.errorTarget&&!se(i)||e.maxDepth>0&&i.__depth+1>=e.maxDepth||!te(i))}function xe(i,e){if(e.ensureChildrenArePreprocessed(i),ne(i,e),!i.__inFrustum)return;if(!et(i,e)){ee(i,e);return}let t=!1,s=!1;const n=i.children;for(let r=0,o=n.length;r<o;r++){const a=n[r];xe(a,e),t=t||B(a,e.frameCount),s=s||a.__inFrustum}if(i.refine==="REPLACE"&&!s&&n.length!==0){i.__inFrustum=!1;for(let r=0,o=n.length;r<o;r++)K(n[r],e,!0);return}if(ee(i,e),i.refine==="REPLACE"&&(t&&i.__depth!==0||ye))for(let r=0,o=n.length;r<o;r++)K(n[r],e)}function Se(i,e){const t=e.frameCount;if(!B(i,t))return;const s=i.children;let n=!1;for(let r=0,o=s.length;r<o;r++){const a=s[r];n=n||B(a,t)}if(!n)i.__isLeaf=!0;else{let r=!0;for(let o=0,a=s.length;o<a;o++){const l=s[o];if(Se(l,e),B(l,t)){const h=!se(l);let c=!l.__hasContent||l.__hasRenderableContent&&Te(l.__loadingState)||l.__hasUnrenderableContent&&l.__loadingState===I;c=h&&c||l.__allChildrenReady,r=r&&c}}i.__allChildrenReady=r}}function we(i,e){const t=e.stats;if(!B(i,e.frameCount))return;if(i.__isLeaf){i.__loadingState===N?(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++):i.__hasContent&&e.queueTileForDownload(i);return}const s=i.children,n=i.__hasContent,r=Te(i.__loadingState)&&n,o=(e.errorTarget+1)*e.errorThreshold,a=i.__error<=o,l=i.refine==="ADD",h=i.__allChildrenReady||i.__depth===0&&!ye;if(n&&(a||l)&&e.queueTileForDownload(i),(a&&r&&!h||r&&l)&&(i.__inFrustum&&(i.__visible=!0,t.visible++),i.__active=!0,t.active++),!l&&a&&!h)for(let c=0,p=s.length;c<p;c++){const f=s[c];B(f,e.frameCount)&&ve(f,e)}else for(let c=0,p=s.length;c<p;c++)we(s[c],e)}function Pe(i,e){const t=B(i,e.frameCount);if(t||i.__usedLastFrame){let s=!1,n=!1;t?(s=i.__active,e.displayActiveTiles?n=i.__active||i.__visible:n=i.__visible):ne(i,e),i.__hasRenderableContent&&i.__loadingState===N&&(i.__wasSetActive!==s&&e.invokeOnePlugin(o=>o.setTileActive&&o.setTileActive(i,s)),i.__wasSetVisible!==n&&e.invokeOnePlugin(o=>o.setTileVisible&&o.setTileVisible(i,n))),i.__wasSetActive=s,i.__wasSetVisible=n,i.__usedLastFrame=t;const r=i.children;for(let o=0,a=r.length;o<a;o++){const l=r[o];Pe(l,e)}}}function tt(i){let e=null;return()=>{e===null&&(e=requestAnimationFrame(()=>{e=null,i()}))}}function st(i,e=null,t=null){const s=[];for(s.push(i),s.push(null),s.push(0);s.length>0;){const n=s.pop(),r=s.pop(),o=s.pop();if(e&&e(o,r,n)){t&&t(o,r,n);return}const a=o.children;if(a)for(let l=a.length-1;l>=0;l--)s.push(a[l]),s.push(o),s.push(n+1);t&&t(o,r,n)}}function St(i,e=null){let t=i;for(;t;){const s=t.__depth,n=t.parent;e&&e(t,n,s),t=n}}const le=Symbol("PLUGIN_REGISTERED"),ce=(i,e)=>{const t=i.priority||0,s=e.priority||0;return t!==s?t>s?1:-1:i.__used!==e.__used?i.__used?1:-1:i.__error!==e.__error?i.__error>e.__error?1:-1:i.__distanceFromCamera!==e.__distanceFromCamera?i.__distanceFromCamera>e.__distanceFromCamera?-1:1:i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?-1:1:0},nt=(i,e)=>{const t=i.priority||0,s=e.priority||0;return t!==s?t>s?1:-1:i.__lastFrameVisited!==e.__lastFrameVisited?i.__lastFrameVisited>e.__lastFrameVisited?-1:1:i.__depthFromRenderedParent!==e.__depthFromRenderedParent?i.__depthFromRenderedParent>e.__depthFromRenderedParent?1:-1:i.__loadingState!==e.__loadingState?i.__loadingState>e.__loadingState?-1:1:i.__hasUnrenderableContent!==e.__hasUnrenderableContent?i.__hasUnrenderableContent?-1:1:i.__error!==e.__error?i.__error>e.__error?-1:1:0};class it{get root(){const e=this.rootTileset;return e?e.root:null}get rootTileSet(){return console.warn('TilesRenderer: "rootTileSet" has been deprecated. Use "rootTileset" instead.'),this.rootTileset}get loadProgress(){const{stats:e,isLoading:t}=this,s=e.downloading+e.parsing,n=e.inCacheSinceLoad+(t?1:0);return n===0?1:1-s/n}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=F,this.rootTileset=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set,this.isLoading=!1;const t=new Ke;t.unloadPriorityCallback=nt;const s=new Y;s.maxJobs=25,s.priorityCallback=ce;const n=new Y;n.maxJobs=5,n.priorityCallback=ce;const r=new Y;r.maxJobs=25,this.processedTiles=new WeakSet,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=s,this.parseQueue=n,this.processNodeQueue=r,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this._dispatchNeedsUpdateEvent=tt(()=>{this.dispatchEvent({type:"needs-update"})}),this.errorTarget=16,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(e[le]===!0)throw new Error("TilesRendererBase: A plugin can only be registered to a single tileset");e.loadRootTileSet&&!e.loadRootTileset&&(console.warn('TilesRendererBase: Plugin implements deprecated "loadRootTileSet" method. Please rename to "loadRootTileset".'),e.loadRootTileset=e.loadRootTileSet),e.preprocessTileSet&&!e.preprocessTileset&&(console.warn('TilesRendererBase: Plugin implements deprecated "preprocessTileSet" method. Please rename to "preprocessTileset".'),e.preprocessTileset=e.preprocessTileSet);const t=this.plugins,s=e.priority||0;let n=t.length;for(let r=0;r<t.length;r++)if((t[r].priority||0)>s){n=r;break}t.splice(n,0,e),e[le]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if(typeof e=="string"&&(e=this.getPluginByName(e)),t.includes(e)){const s=t.indexOf(e);return t.splice(s,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find(t=>t.name===e)||null}invokeOnePlugin(e){const t=[...this.plugins,this];for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}invokeAllPlugins(e){const t=[...this.plugins,this],s=[];for(let n=0;n<t.length;n++){const r=e(t[n]);r&&s.push(r)}return s.length===0?null:Promise.all(s)}traverse(e,t,s=!0){this.root&&st(this.root,(n,...r)=>(s&&this.ensureChildrenArePreprocessed(n,!0),e?e(n,...r):!1),t)}getAttributions(e=[]){return this.invokeAllPlugins(t=>t!==this&&t.getAttributions&&t.getAttributions(e)),e}update(){const{lruCache:e,usedSet:t,stats:s,root:n,downloadQueue:r,parseQueue:o,processNodeQueue:a}=this;if(this.rootLoadingState===F&&(this.rootLoadingState=z,this.invokeOnePlugin(c=>c.loadRootTileset&&c.loadRootTileset()).then(c=>{let p=this.rootURL;p!==null&&this.invokeAllPlugins(f=>p=f.preprocessURL?f.preprocessURL(p,null):p),this.rootLoadingState=N,this.rootTileset=c,this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),this.dispatchEvent({type:"load-tileset",tileset:c,url:p})}).catch(c=>{this.rootLoadingState=I,console.error(c),this.rootTileset=null,this.dispatchEvent({type:"load-error",tile:null,error:c,url:this.rootURL})})),!n)return;s.inFrustum=0,s.used=0,s.active=0,s.visible=0,this.frameCount++,t.forEach(c=>e.markUnused(c)),t.clear(),xe(n,this),Se(n,this),we(n,this),Pe(n,this);const l=this.queuedTiles;l.sort(e.unloadPriorityCallback);for(let c=0,p=l.length;c<p&&!e.isFull();c++)this.requestTileContents(l[c]);l.length=0,e.scheduleUnload(),(r.running||o.running||a.running)===!1&&this.isLoading===!0&&(this.cachedSinceLoadComplete.clear(),s.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}),this.isLoading=!1)}resetFailedTiles(){this.rootLoadingState===I&&(this.rootLoadingState=F);const e=this.stats;e.failed!==0&&(this.traverse(t=>{t.__loadingState===I&&(t.__loadingState=F)},null,!1),e.failed=0)}dispose(){[...this.plugins].forEach(n=>{this.unregisterPlugin(n)});const t=this.lruCache,s=[];this.traverse(n=>(s.push(n),!1),null,!1);for(let n=0,r=s.length;n<r;n++)t.remove(s[n]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}calculateBytesUsed(e,t){return 0}dispatchEvent(e){}addEventListener(e,t){}removeEventListener(e,t){}parseTile(e,t,s){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin(t=>t.setTileVisible&&t.setTileVisible(e,!1)),e.__visible=!1),e.__active&&(this.invokeOnePlugin(t=>t.setTileActive&&t.setTileActive(e,!1)),e.__active=!1)}preprocessNode(e,t,s=null){var n;if(this.processedTiles.add(e),e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=s,e.children=e.children||[],(n=e.content)!=null&&n.uri){const r=oe(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=!!(r&&/json$/.test(r)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__childrenProcessed=0,s&&s.__childrenProcessed++,e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__allChildrenReady=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=F,s===null?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=s.__depth+1,e.__depthFromRenderedParent=s.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||s.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins(r=>{r!==this&&r.preprocessNode&&r.preprocessNode(e,t,s)})}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateTileViewError(e,t){}queueTileForDownload(e){e.__loadingState!==F||this.lruCache.isFull()||this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}fetchData(e,t){return fetch(e,t)}ensureChildrenArePreprocessed(e,t=!1){const s=e.children;for(let n=0,r=s.length;n<r;n++){const o=s[n];if("__depth"in o)break;t?(this.processNodeQueue.remove(o),this.preprocessNode(o,e.__basePath,e)):this.processNodeQueue.has(o)||this.processNodeQueue.add(o,a=>{this.preprocessNode(a,e.__basePath,e),this._dispatchNeedsUpdateEvent()})}}getBytesUsed(e){let t=0;return this.invokeAllPlugins(s=>{s.calculateBytesUsed&&(t+=s.calculateBytesUsed(e,e.cached.scene)||0)}),t}recalculateBytesUsed(e=null){const{lruCache:t,processedTiles:s}=this;e===null?t.itemSet.forEach(n=>{s.has(n)&&t.setMemoryUsage(n,this.getBytesUsed(n))}):t.setMemoryUsage(e,this.getBytesUsed(e))}preprocessTileset(e,t,s=null){const n=Object.getPrototypeOf(this);Object.hasOwn(n,"preprocessTileSet")&&console.warn(`${n.constructor.name}: Class overrides deprecated "preprocessTileSet" method. Please rename to "preprocessTileset".`);const r=e.asset.version,[o,a]=r.split(".").map(h=>parseInt(h));console.assert(o<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),o===1&&a>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let l=t.replace(/\/[^/]*$/,"");l=new URL(l,window.location.href).toString(),this.preprocessNode(e.root,l,s)}preprocessTileSet(...e){return console.warn('TilesRenderer: "preprocessTileSet" has been deprecated. Use "preprocessTileset" instead.'),this.preprocessTileset(...e)}loadRootTileset(){const e=Object.getPrototypeOf(this);Object.hasOwn(e,"loadRootTileSet")&&console.warn(`${e.constructor.name}: Class overrides deprecated "loadRootTileSet" method. Please rename to "loadRootTileset".`);let t=this.rootURL;return this.invokeAllPlugins(n=>t=n.preprocessURL?n.preprocessURL(t,null):t),this.invokeOnePlugin(n=>n.fetchData&&n.fetchData(t,this.fetchOptions)).then(n=>{if(n instanceof Response){if(n.ok)return n.json();throw new Error(`TilesRenderer: Failed to load tileset "${t}" with status ${n.status} : ${n.statusText}`)}else return n}).then(n=>(this.preprocessTileset(n,t),n))}loadRootTileSet(...e){return console.warn('TilesRenderer: "loadRootTileSet" has been deprecated. Use "loadRootTileset" instead.'),this.loadRootTileSet(...e)}requestTileContents(e){if(e.__loadingState!==F)return;let t=!1,s=null,n=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins(d=>n=d.preprocessURL?d.preprocessURL(n,e):n);const r=this.stats,o=this.lruCache,a=this.downloadQueue,l=this.parseQueue,h=oe(n),c=new AbortController,p=c.signal;if(o.add(e,d=>{c.abort(),t?(d.children.length=0,d.__childrenProcessed=0):this.invokeAllPlugins(_=>{_.disposeTile&&_.disposeTile(d)}),r.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),r.inCacheSinceLoad--),d.__loadingState===z?r.downloading--:d.__loadingState===H&&r.parsing--,d.__loadingState=F,l.remove(d),a.remove(d)}))return this.isLoading||(this.isLoading=!0,this.dispatchEvent({type:"tiles-load-start"})),o.setMemoryUsage(e,this.getBytesUsed(e)),this.cachedSinceLoadComplete.add(e),r.inCacheSinceLoad++,r.inCache++,r.downloading++,e.__loadingState=z,a.add(e,d=>{if(p.aborted)return Promise.resolve();const _=this.invokeOnePlugin(m=>m.fetchData&&m.fetchData(n,{...this.fetchOptions,signal:p}));return this.dispatchEvent({type:"tile-download-start",tile:e}),_}).then(d=>{if(!p.aborted)if(d instanceof Response){if(d.ok)return h==="json"?d.json():d.arrayBuffer();throw new Error(`Failed to load model with error code ${d.status}`)}else return d}).then(d=>{if(!p.aborted)return r.downloading--,r.parsing++,e.__loadingState=H,l.add(e,_=>p.aborted?Promise.resolve():h==="json"&&d.root?(this.preprocessTileset(d,n,e),e.children.push(d.root),s=d,t=!0,Promise.resolve()):this.invokeOnePlugin(m=>m.parseTile&&m.parseTile(d,_,h,n,p)))}).then(()=>{if(p.aborted)return;r.parsing--,e.__loadingState=N,o.setLoaded(e,!0);const d=this.getBytesUsed(e);if(o.getMemoryUsage(e)===0&&d>0&&o.isFull()){o.remove(e);return}o.setMemoryUsage(e,d),this.dispatchEvent({type:"needs-update"}),this.dispatchEvent({type:"load-content"}),t&&this.dispatchEvent({type:"load-tileset",tileset:s,url:n}),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e})}).catch(d=>{p.aborted||(d.name!=="AbortError"?(l.remove(e),a.remove(e),e.__loadingState===H?r.parsing--:e.__loadingState===z&&r.downloading--,r.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(d),e.__loadingState=I,o.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:d,url:n})):o.remove(e))})}}const O=new k;class rt extends _e{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new k}raycast(e,t){return this.tilesRenderer.optimizeRaycast?(this.tilesRenderer.raycast(e,t),!1):!0}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){this.parent===null?O.copy(this.matrix):O.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const t=O.elements,s=this.matrixWorld.elements;let n=!1;for(let r=0;r<16;r++){const o=t[r],a=s[r];if(Math.abs(o-a)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(O),this.matrixWorldInverse.copy(O).invert();const r=this.children;for(let o=0,a=r.length;o<a;o++)r[o].updateMatrixWorld()}}}updateWorldMatrix(e,t){this.parent&&e&&this.parent.updateWorldMatrix(e,!1),this.updateMatrixWorld(!0)}}const Ce=new ge,X=new y,W=[];function Re(i,e){return i.distance-e.distance}function Me(i,e,t,s){const{scene:n}=i.cached;t.invokeOnePlugin(o=>o.raycastTile&&o.raycastTile(i,n,e,s))||e.intersectObject(n,!0,s)}function ot(i,e,t){Me(i,e,t,W),W.sort(Re);const s=W[0]||null;return W.length=0,s}function Ue(i){return"__used"in i}function ke(i,e,t,s=null){const{group:n,activeTiles:r}=i;s===null&&(s=Ce,s.copy(t.ray).applyMatrix4(n.matrixWorldInverse));const o=[],a=e.children;for(let c=0,p=a.length;c<p;c++){const f=a[c];if(!Ue(f)||!f.__used)continue;f.cached.boundingVolume.intersectRay(s,X)!==null&&(X.applyMatrix4(n.matrixWorld),o.push({distance:X.distanceToSquared(t.ray.origin),tile:f}))}o.sort(Re);let l=null,h=1/0;if(r.has(e)){const c=ot(e,t,i);c&&(l=c,h=c.distance*c.distance)}for(let c=0,p=o.length;c<p;c++){const f=o[c],d=f.distance,_=f.tile;if(d>h)break;const m=ke(i,_,t,s);if(m){const b=m.distance*m.distance;b<h&&(l=m,h=b)}}return l}function Le(i,e,t,s,n=null){if(!Ue(e))return;const{group:r,activeTiles:o}=i,{boundingVolume:a}=e.cached;if(n===null&&(n=Ce,n.copy(t.ray).applyMatrix4(r.matrixWorldInverse)),!e.__used||!a.intersectsRay(n))return;o.has(e)&&Me(e,t,i,s);const l=e.children;for(let h=0,c=l.length;h<c;h++)Le(i,l[h],t,s,n)}const Q=new y,G=new y,v=new y,J=new ge;class he{constructor(e=new je,t=new k){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new k,this.points=new Array(8).fill().map(()=>new y),this.planes=new Array(6).fill().map(()=>new qe)}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return new this.constructor().copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,v).distanceTo(e)}containsPoint(e){return v.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(v)}intersectsRay(e){return J.copy(e).applyMatrix4(this.inverseTransform),J.intersectsBox(this.box)}intersectRay(e,t){return J.copy(e).applyMatrix4(this.inverseTransform),J.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:s,box:n}=this;t.copy(s).invert();const{min:r,max:o}=n;let a=0;for(let l=-1;l<=1;l+=2)for(let h=-1;h<=1;h+=2)for(let c=-1;c<=1;c+=2)e[a].set(l<0?r.x:o.x,h<0?r.y:o.y,c<0?r.z:o.z).applyMatrix4(s),a++;this.updatePlanes()}updatePlanes(){Q.copy(this.box.min).applyMatrix4(this.transform),G.copy(this.box.max).applyMatrix4(this.transform),v.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(v,Q),this.planes[1].setFromNormalAndCoplanarPoint(v,G).negate(),v.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(v,Q),this.planes[3].setFromNormalAndCoplanarPoint(v,G).negate(),v.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(v,Q),this.planes[5].setFromNormalAndCoplanarPoint(v,G).negate()}intersectsSphere(e){return this.clampPoint(e.center,v),v.distanceToSquared(e.center)<=e.radius*e.radius}intersectsFrustum(e){return this._intersectsPlaneShape(e.planes,e.points)}intersectsOBB(e){return this._intersectsPlaneShape(e.planes,e.points)}_intersectsPlaneShape(e,t){const s=this.points,n=this.planes;for(let r=0;r<6;r++){const o=e[r];let a=-1/0;for(let l=0;l<8;l++){const h=s[l],c=o.distanceToPoint(h);a=a<c?c:a}if(a<0)return!1}for(let r=0;r<6;r++){const o=n[r];let a=-1/0;for(let l=0;l<8;l++){const h=t[l],c=o.distanceToPoint(h);a=a<c?c:a}if(a<0)return!1}return!0}}const R=new y,M=new y,U=new y,de=new y,ue=new y;class at{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,s=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||s&&!s.intersectsRay(e))}intersectRay(e,t=null){const s=this.sphere,n=this.obb||this.regionObb;let r=-1/0,o=-1/0;s&&e.intersectSphere(s,de)&&(r=s.containsPoint(e.origin)?0:e.origin.distanceToSquared(de)),n&&n.intersectRay(e,ue)&&(o=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(ue));const a=Math.max(r,o);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,s=this.obb||this.regionObb;let n=-1/0,r=-1/0;return t&&(n=Math.max(t.distanceToPoint(e),0)),s&&(r=s.distanceToPoint(e)),n>r?n:r}intersectsFrustum(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsFrustum(e)?!1:!!(s||t)}intersectsSphere(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!s.intersectsSphere(e)||t&&!t.intersectsSphere(e)?!1:!!(s||t)}intersectsOBB(e){const t=this.obb||this.regionObb,s=this.sphere;return s&&!e.intersectsSphere(s)||t&&!t.intersectsOBB(e)?!1:!!(s||t)}getOBB(e,t){const s=this.obb||this.regionObb;s?(e.copy(s.box),t.copy(s.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const s=new he;R.set(e[3],e[4],e[5]),M.set(e[6],e[7],e[8]),U.set(e[9],e[10],e[11]);const n=R.length(),r=M.length(),o=U.length();R.normalize(),M.normalize(),U.normalize(),n===0&&R.crossVectors(M,U),r===0&&M.crossVectors(R,U),o===0&&U.crossVectors(R,M),s.transform.set(R.x,M.x,U.x,e[0],R.y,M.y,U.y,e[1],R.z,M.z,U.z,e[2],0,0,0,1).premultiply(t),s.box.min.set(-n,-r,-o),s.box.max.set(n,r,o),s.update(),this.obb=s}setSphereData(e,t,s,n,r){const o=new We;o.center.set(e,t,s),o.radius=n,o.applyMatrix4(r),this.sphere=o}setRegionData(e,t,s,n,r,o,a){const l=new Ye(...e.radius,s,r,t,n,o,a),h=new he;l.getBoundingBox(h.box,h.transform),h.update(),this.region=l,this.regionObb=h}}const lt=new Ge;function ct(i,e,t,s){const n=lt.set(i.normal.x,i.normal.y,i.normal.z,e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z);return s.set(-i.constant,-e.constant,-t.constant),s.applyMatrix3(n.invert()),s}class ht extends Qe{constructor(){super(),this.points=Array(8).fill().map(()=>new y)}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach((n,r)=>{ct(n[0],n[1],n[2],t[r])})}}function dt(i){if(!i)return 0;const{format:e,type:t,image:s}=i,{width:n,height:r}=s;let o=Je.getByteLength(n,r,e,t);return o*=i.generateMipmaps?4/3:1,o}function ut(i){const e=new Set;let t=0;return i.traverse(s=>{if(s.geometry&&!e.has(s.geometry)&&(t+=Xe(s.geometry),e.add(s.geometry)),s.material){const n=s.material;for(const r in n){const o=n[r];o&&o.isTexture&&!e.has(o)&&(t+=dt(o),e.add(o))}}}),t}const pe=new k,fe=new He,Fe=Symbol("INITIAL_FRUSTUM_CULLED"),$=new k,V=new y,Z=new be,A={inView:!1,error:1/0},pt=new y(1,0,0),ft=new y(0,1,0);function me(i,e){i.traverse(t=>{t.frustumCulled=t[Fe]&&e})}class wt extends it{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel(t=>{me(t,!e)}))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new rt(this),this.ellipsoid=Ae.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new k,this._bytesUsed=new WeakMap,this._autoDisableRendererCulling=!0,this.manager=new $e,this._listeners={}}addEventListener(e,t){e==="load-tile-set"&&(console.warn('TilesRenderer: "load-tile-set" event has been deprecated. Use "load-tileset" instead.'),e="load-tileset"),j.prototype.addEventListener.call(this,e,t)}hasEventListener(e,t){return e==="load-tile-set"&&(console.warn('TilesRenderer: "load-tile-set" event has been deprecated. Use "load-tileset" instead.'),e="load-tileset"),j.prototype.hasEventListener.call(this,e,t)}removeEventListener(e,t){e==="load-tile-set"&&(console.warn('TilesRenderer: "load-tile-set" event has been deprecated. Use "load-tileset" instead.'),e="load-tileset"),j.prototype.removeEventListener.call(this,e,t)}dispatchEvent(e){"tileset"in e&&Object.defineProperty(e,"tileSet",{get(){return console.warn('TilesRenderer: "event.tileSet" has been deprecated. Use "event.tileset" instead.'),e.tileset},enumerable:!1,configurable:!0}),j.prototype.dispatchEvent.call(this,e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getAABB(e),!0):!1}getOrientedBoundingBox(e,t){if(!this.root)return!1;const s=this.root.cached.boundingVolume;return s?(s.getOBB(e,t),!0):!1}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return t?(t.getSphere(e),!0):!1}forEachLoadedModel(e){this.traverse(t=>{const s=t.cached&&t.cached.scene;s&&e(s,t)},null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const s=ke(this,this.root,e);s&&t.push(s)}else Le(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,s=this.cameraMap;return s.has(e)?!1:(s.set(e,new be),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,s){const n=this.cameraMap;if(!n.has(e))return!1;const r=t.isVector2?t.x:t,o=t.isVector2?t.y:s,a=n.get(e);return(a.width!==r||a.height!==o)&&(a.set(r,o),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(Z),this.setResolution(e,Z.x,Z.y)}deleteCamera(e){const t=this.cameras,s=this.cameraMap;if(s.has(e)){const n=t.indexOf(e);return t.splice(n,1),s.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileset(...e){return super.loadRootTileset(...e).then(t=>{const{asset:s,extensions:n={}}=t;switch((s&&s.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(ft,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(pt,Math.PI/2);break}if("3DTILES_ellipsoid"in n){const o=n["3DTILES_ellipsoid"],{ellipsoid:a}=this;a.name=o.body,o.radii?a.radius.set(...o.radii):a.radius.set(1,1,1)}return t})}update(){let e=null;if(this.invokeAllPlugins(o=>{if(o.doTilesNeedUpdate){const a=o.doTilesNeedUpdate();e===null?e=a:e=!!(e||a)}}),e===!1){this.dispatchEvent({type:"update-before"}),this.dispatchEvent({type:"update-after"});return}this.dispatchEvent({type:"update-before"});const t=this.group,s=this.cameras,n=this.cameraMap,r=this.cameraInfo;for(;r.length>s.length;)r.pop();for(;r.length<s.length;)r.push({frustum:new ht,isOrthographic:!1,sseDenominator:-1,position:new y,invScale:-1,pixelSize:0});V.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(V.x-V.y,V.x-V.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let o=0,a=r.length;o<a;o++){const l=s[o],h=r[o],c=h.frustum,p=h.position,f=n.get(l);(f.width===0||f.height===0)&&console.warn("TilesRenderer: resolution for camera error calculation is not set.");const d=l.projectionMatrix.elements;if(h.isOrthographic=d[15]===1,h.isOrthographic){const _=2/d[0],m=2/d[5];h.pixelSize=Math.max(m/f.height,_/f.width)}else h.sseDenominator=2/d[5]/f.height;$.copy(t.matrixWorld),$.premultiply(l.matrixWorldInverse),$.premultiply(l.projectionMatrix),c.setFromProjectionMatrix($),p.set(0,0,0),p.applyMatrix4(l.matrixWorld),p.applyMatrix4(t.matrixWorldInverse)}if(super.update(),this.dispatchEvent({type:"update-after"}),s.length===0&&this.root){let o=!1;this.invokeAllPlugins(a=>o=o||!!(a!==this&&a.calculateTileViewError)),o===!1&&console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}}preprocessNode(e,t,s=null){super.preprocessNode(e,t,s);const n=new k;if(e.transform){const a=e.transform;for(let l=0;l<16;l++)n.elements[l]=a[l]}s&&n.premultiply(s.cached.transform);const r=new k().copy(n).invert(),o=new at;"sphere"in e.boundingVolume&&o.setSphereData(...e.boundingVolume.sphere,n),"box"in e.boundingVolume&&o.setObbData(e.boundingVolume.box,n),"region"in e.boundingVolume&&o.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:n,transformInverse:r,active:!1,boundingVolume:o,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async parseTile(e,t,s,n,r){const o=t.cached,a=De(n),l=this.fetchOptions,h=this.manager;let c=null;const p=o.transform,f=this._upRotationMatrix,d=(Oe(e)||s).toLowerCase();switch(d){case"b3dm":{const u=new Ve(h);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(f),c=u.parse(e);break}case"pnts":{const u=new Ne(h);u.workingPath=a,u.fetchOptions=l,c=u.parse(e);break}case"i3dm":{const u=new Ie(h);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(f),u.ellipsoid.copy(this.ellipsoid),c=u.parse(e);break}case"cmpt":{const u=new ze(h);u.workingPath=a,u.fetchOptions=l,u.adjustmentTransform.copy(f),u.ellipsoid.copy(this.ellipsoid),c=u.parse(e).then(T=>T.scene);break}case"gltf":case"glb":{const u=h.getHandler("path.gltf")||h.getHandler("path.glb")||new Ze(h);u.setWithCredentials(l.credentials==="include"),u.setRequestHeader(l.headers||{}),l.credentials==="include"&&l.mode==="cors"&&u.setCrossOrigin("use-credentials");let T=u.resourcePath||u.path||a;!/[\\/]$/.test(T)&&T.length&&(T+="/"),c=u.parseAsync(e,T).then(x=>{x.scene=x.scene||new _e;const{scene:w}=x;return w.updateMatrix(),w.matrix.multiply(f).decompose(w.position,w.quaternion,w.scale),x});break}default:{c=this.invokeOnePlugin(u=>u.parseToMesh&&u.parseToMesh(e,t,s,n,r));break}}const _=await c;if(_===null)throw new Error(`TilesRenderer: Content type "${d}" not supported.`);let m,b;_.isObject3D?(m=_,b=null):(m=_.scene,b=_),m.updateMatrix(),m.matrix.premultiply(p),m.matrix.decompose(m.position,m.quaternion,m.scale),await this.invokeAllPlugins(u=>u.processTileModel&&u.processTileModel(m,t)),m.traverse(u=>{u[Fe]=u.frustumCulled}),me(m,!this.autoDisableRendererCulling);const P=[],L=[],D=[];if(m.traverse(u=>{if(u.geometry&&L.push(u.geometry),u.material){const T=u.material;P.push(u.material);for(const x in T){const w=T[x];w&&w.isTexture&&D.push(w)}}}),r.aborted){for(let u=0,T=D.length;u<T;u++){const x=D[u];x.image instanceof ImageBitmap&&x.image.close(),x.dispose()}return}o.materials=P,o.geometry=L,o.textures=D,o.scene=m,o.metadata=b}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const s=t.materials,n=t.geometry,r=t.textures,o=t.scene.parent;t.scene.traverse(a=>{a.userData.meshFeatures&&a.userData.meshFeatures.dispose(),a.userData.structuralMetadata&&a.userData.structuralMetadata.dispose()});for(let a=0,l=n.length;a<l;a++)n[a].dispose();for(let a=0,l=s.length;a<l;a++)s[a].dispose();for(let a=0,l=r.length;a<l;a++){const h=r[a];h.image instanceof ImageBitmap&&h.image.close(),h.dispose()}o&&o.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const s=e.cached.scene,n=this.group;t?s&&(n.add(s),s.updateMatrixWorld(!0)):s&&n.remove(s),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:s,tile:e,visible:t})}calculateBytesUsed(e,t){const s=this._bytesUsed;return!s.has(e)&&t&&s.set(e,ut(t)),s.get(e)??null}calculateTileViewError(e,t){const s=e.cached,n=this.cameras,r=this.cameraInfo,o=s.boundingVolume;let a=!1,l=-1/0,h=1/0,c=-1/0,p=1/0;for(let f=0,d=n.length;f<d;f++){const _=r[f];let m,b;if(_.isOrthographic){const L=_.pixelSize;m=e.geometricError/L,b=1/0}else{const L=_.sseDenominator;b=o.distanceToPoint(_.position),m=b===0?1/0:e.geometricError/(b*L)}const P=r[f].frustum;o.intersectsFrustum(P)&&(a=!0,l=Math.max(l,m),h=Math.min(h,b)),c=Math.max(c,m),p=Math.min(p,b)}this.invokeAllPlugins(f=>{f!==this&&f.calculateTileViewError&&f.calculateTileViewError(e,A)&&(a=a&&A.inView,c=Math.max(c,A.error),A.inView&&(l=Math.max(l,A.error)))}),a?(t.inView=!0,t.error=l,t.distanceFromCamera=h):(t.inView=A.inView,t.error=c,t.distanceFromCamera=p)}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:s,group:n}=this;fe.set(Math.PI/2,Math.PI/2,0),pe.makeRotationFromEuler(fe),s.getEastNorthUpFrame(e,t,0,n.matrix).multiply(pe).invert().decompose(n.position,n.quaternion,n.scale),n.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}export{Ke as L,he as O,Y as P,wt as T,st as a,dt as g,St as t};
//# sourceMappingURL=TilesRenderer-urYYbZ2A.js.map
