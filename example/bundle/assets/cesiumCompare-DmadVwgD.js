import{M as C,T as G,W as P,S as k,a as U,d as H,D as I,e as j,E as O}from"./three.module-DBfedTbk.js";import{T as V}from"./TilesRenderer-urYYbZ2A.js";import{C as S}from"./Ellipsoid-CLPX16sm.js";import{G as q}from"./GlobeControls-Dgl9ILXZ.js";import{E as N}from"./EnvironmentControls-BytJqcEY.js";import{e as K}from"./GLTFLoader-BjagHNWe.js";import{D as $}from"./DRACOLoader-BzMKjVbk.js";import{K as J}from"./KTX2Loader-CCFeOZ0g.js";import{G as X}from"./GLTFExtensionsPlugin-CPIAc_W2.js";import"./I3DMLoader-Co8j1K3i.js";import"./BatchTable-CRr3zuRk.js";import"./B3DMLoader-D_8ejTd0.js";import"./PNTSLoader-C47qgwy1.js";import"./CMPTLoader-CdR2x6K5.js";import"./EllipsoidRegion-By3sIuka.js";const b=new URLSearchParams(location.search).get("url")||"../data/tileset.json",A=document.getElementById("three-container"),z=document.getElementById("cesium-container"),f=A.getElementsByClassName("stats")[0],h=z.getElementsByClassName("stats")[0];let r,s,v=!1;(async()=>(await Y(),await Z(),window.addEventListener("keydown",e=>{e.key===" "&&document.body.classList.toggle("fullscreen")}),Q(),setInterval(()=>{const{camera:e}=s,{position:n,rotation:o}=e,a=[...n,o.x,o.y,o.z].map(t=>parseFloat(t.toFixed(4)));window.history.replaceState(void 0,void 0,`#${JSON.stringify(a)}`)},100),W()))();function Q(){const e=window.location.hash.replace(/^#/,"");if(!e)return;const[n,o,a,t,u,m]=JSON.parse(unescape(e)),{camera:i}=s;i.position.set(n,o,a),i.rotation.set(t,u,m),v=!0}function W(){requestAnimationFrame(W),window.THREE_DATA=s,window.CESIUM_DATA=r,s.update();const n=s.tiles.ellipsoid.getCartographicFromObjectFrame(s.camera.matrixWorld,{},S);r.camera.frustum.near=s.camera.near,r.camera.frustum.far=s.camera.far,r.camera.frustum.fov=ee(s.camera.fov,s.camera.aspect)*C.DEG2RAD,r.camera.position.x=s.camera.position.x,r.camera.position.y=s.camera.position.y,r.camera.position.z=s.camera.position.z,r.camera.setView({destination:r.position,orientation:{roll:n.roll,pitch:n.elevation,heading:n.azimuth}}),r.update();let o,a,t,u,m;a=0,u=0,m=0,s.tiles.forEachLoadedModel((i,d)=>{a++,i.traverse(y=>{const{geometry:T,material:E}=y;if(T){m+=K(y.geometry);for(const R in E){const g=E[R];if(g&&g.isTexture){const{format:L,type:M,image:w}=g,{width:B,height:c}=w;let p=G.getByteLength(B,c,L,M);p*=g.generateMipmaps?4/3:1,u+=p}}}})}),o=0,x(s.root,i=>{if(i.__hasRenderableContent&&i.__loadingState!==0)return o++,!0}),t=0,x(s.root,(i,d)=>{i.__hasContent&&i.__loadingState!==0&&t++}),F(f),l(f,"visible tiles",s.tiles.visibleTiles.size),l(f,"loaded tiles",t),l(f,"loaded geom tiles",a),l(f,"loaded subtree tiles",t-a),l(f,"loaded layer 1 tiles",o),l(f,"total memory",(s.tiles.lruCache.cachedBytes*1e-6).toFixed(3)+" MB"),l(f,"geometry memory",(m*1e-6).toFixed(3)+" MB"),l(f,"texture memory",(u*1e-6).toFixed(3)+" MB"),o=0,x(r.root,i=>{if(i._content&&i._content.ready&&i._content._model)return o++,!0}),t=0,m=0,u=0,x(r.root,(i,d)=>{i._content&&i._content.ready&&(d!==0&&t++,i._content._model&&(m+=i._content._model.statistics.geometryByteLength,u+=i._content._model.statistics.texturesByteLength))}),F(h),l(h,"visible tiles",r.tiles.statistics.selected),l(h,"loaded tiles",t),l(h,"loaded geom tiles",r.tiles.statistics.numberOfTilesWithContentReady),l(h,"loaded subtree tiles",t-r.tiles.statistics.numberOfTilesWithContentReady),l(h,"loaded layer 1 tiles",o),l(h,"total memory",(r.tiles.totalMemoryUsageInBytes*1e-6).toFixed(3)+" MB"),l(h,"geometry memory",(m*1e-6).toFixed(3)+" MB"),l(h,"texture memory",(u*1e-6).toFixed(3)+" MB")}async function Y(){const e=new P({antialias:!0});e.setClearColor(0),A.appendChild(e.domElement),e.domElement.style.imageRendering="pixelated",e.setPixelRatio(window.devicePixelRatio);const n=new k,o=window.innerWidth/window.innerHeight,a=60,t=new U(D(a,o),o,.1,1e10);t.position.set(-1.3567366495227425e6,529850286925096e-8,3.2711939085458643e6),t.quaternion.set(.27330445532852865,-.4460582045331912,-.821679716911258,.2262281938283491);const u=new $;u.setDecoderPath("https://unpkg.com/three@0.153.0/examples/jsm/libs/draco/gltf/");const m=new J;m.setTranscoderPath("https://unpkg.com/three@0.153.0/examples/jsm/libs/basis/"),m.detectSupport(e);const i=new V(b);i.registerPlugin(new X({rtc:!0,dracoLoader:u,ktxLoader:m})),i.preprocessURL=c=>unescape(c),i.lruCache.maxBytesSize=1/0,i.lruCache.minBytesSize=0,i.setResolutionFromRenderer(t,e),i.setCamera(t);let d;i.addEventListener("load-tileset",()=>{const c=new H;if(i.getBoundingSphere(c),c.center.distanceTo(t.position)>c.radius*20&&(v=!1),!v){if(v=!0,t.position.copy(c.center),t.position.length()>1e5){const p=c.center.clone().normalize();t.position.addScaledVector(p,c.radius)}else t.position.x+=c.radius,t.position.y+=c.radius,t.position.z+=c.radius;t.lookAt(c.center)}d||(t.position.length()>1e5?(d=new q(n,t,e.domElement,null),d.enableDamping=!0,d.adjustHeight=!1,d.setEllipsoid(i.ellipsoid,i.group)):(d=new N(n,t,e.domElement,null),d.enableDamping=!0,d.adjustHeight=!1))}),n.add(i.group);const y=new I(16777215,2);y.position.set(1,2,3),n.add(y),n.environment=new j(new Uint8Array(4096*4).fill(255),64,64),n.environment.mapping=O,n.environmentIntensity=1/Math.PI,n.environment.needsUpdate=!0,i.ellipsoid.getObjectFrame(.5419733570174874,1.821470691863346,553.1228538149635,0,-.5000321680050197,0,t.matrixWorld,S).decompose(t.position,t.quaternion,t.scale),w(),window.addEventListener("resize",w,!1),s={tiles:i,camera:t,renderer:e,scene:n,update:B,get root(){return i.root}};function w(){const p=e.domElement,_=p.clientWidth/p.clientHeight;t.aspect=_,t.fov=D(60,_),t.updateProjectionMatrix(),e.setSize(p.clientWidth,p.clientHeight,!1)}function B(){w(),d&&d.update(),i.setResolutionFromRenderer(t,e),i.setCamera(t),t.updateMatrixWorld(),i.update(),e.render(n,t)}}async function Z(){const e=new Cesium.CesiumWidget(z);e.scene.terrainProvider=!1,e.scene.skyBox.destroy(),e.scene.skyBox=void 0,e.scene.sun.destroy(),e.scene.sun=void 0,e.scene.backgroundColor=Cesium.Color.BLACK.clone(),e.creditDisplay.container.style.display="none";const n=await Cesium.Cesium3DTileset.fromUrl(b,{maximumCacheOverflowBytes:1e20,cacheBytes:0});e.scene.primitives.add(n);const o=e.camera;r={tiles:n,viewer:e,camera:o,scene:e.scene,update:()=>{},get root(){let a=n._selectedTiles[0];for(;a&&a.parent;)a=a.parent;return a||null}}}function F(e){e.innerHTML=""}function l(e,n,o){e.innerHTML+=`<div name="${n}">${o}</div>`}function D(e,n){return C.RAD2DEG*2*Math.atan(Math.tan(C.DEG2RAD*e/2)/n)}function ee(e,n){return n<1?e:C.RAD2DEG*2*Math.atan(Math.tan(C.DEG2RAD*e/2)*n)}function x(e,n,o=0){e&&!n(e,o)&&e.children&&e.children.forEach(a=>{x(a,n,o+1)})}
//# sourceMappingURL=cesiumCompare-DmadVwgD.js.map
