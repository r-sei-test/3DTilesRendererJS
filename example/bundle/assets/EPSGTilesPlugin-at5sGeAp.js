import{I as tt,T as N,a as O,b as H}from"./ImageFormatPlugin-WUDOeLJL.js";import{m as V,aP as et,d as it,V as st,M as g}from"./three.module-DBfedTbk.js";import{P as F,X as nt,T as ot}from"./TMSImageSource-D41Rs33p.js";import{T as Z}from"./TiledImageSource-smoHuTDQ.js";const D=new V,A=new V;function rt(m,t,e){const i=e+1e-5;let n=t+1e-5;Math.abs(n)>Math.PI/2&&(n=n-1e-5),m.getCartographicToPosition(t,e,0,D),m.getCartographicToPosition(n,e,0,A);const o=D.distanceTo(A)/1e-5;return m.getCartographicToPosition(t,i,0,A),[D.distanceTo(A)/1e-5,o]}const at=30,lt=15,U=new V,z=new V,E=new st,W=new it;class b extends tt{get projection(){return this.tiling.projection}constructor(t={}){const{shape:e="planar",endCaps:s=!0,...i}=t;super(i),this.shape=e,this.endCaps=s}async parseToMesh(t,e,...s){const i=await super.parseToMesh(t,e,...s),{shape:n,projection:o,tiles:r,tiling:l}=this;if(n==="ellipsoid"){const c=r.ellipsoid,a=e[N],h=e[O],T=e[H],[d,f,u,p]=e.boundingVolume.region,M=Math.ceil((p-f)*g.RAD2DEG*.25),S=Math.ceil((u-d)*g.RAD2DEG*.25),P=Math.max(lt,M),B=Math.max(at,S),I=new et(1,1,B,P),[_,C,j,v]=l.getTileBounds(h,T,a,!0,!0),y=l.getTileContentUVBounds(h,T,a),{position:w,normal:$,uv:Y}=I.attributes,k=w.count;e.cached.boundingVolume.getSphere(W);for(let L=0;L<k;L++){U.fromBufferAttribute(w,L),E.fromBufferAttribute(Y,L);const X=o.convertProjectionToLongitude(g.mapLinear(E.x,0,1,_,j));let x=o.convertProjectionToLatitude(g.mapLinear(E.y,0,1,C,v));if(o.isMercator&&this.endCaps&&(v===1&&E.y===1&&(x=Math.PI/2),C===0&&E.y===0&&(x=-Math.PI/2)),o.isMercator&&E.y!==0&&E.y!==1){const R=o.convertProjectionToLatitude(1),G=1/P,J=g.mapLinear(E.y-G,0,1,f,p),K=g.mapLinear(E.y+G,0,1,f,p);x>R&&J<R&&(x=R),x<-R&&K>-R&&(x=-R)}c.getCartographicToPosition(x,X,0,U).sub(W.center),c.getCartographicToNormal(x,X,z);const Q=g.mapLinear(o.convertLongitudeToProjection(X),_,j,y[0],y[2]),q=g.mapLinear(o.convertLatitudeToProjection(x),C,v,y[1],y[3]);Y.setXY(L,Q,q),w.setXYZ(L,...U),$.setXYZ(L,...z)}i.geometry=I,i.position.copy(W.center)}return i}createBoundingVolume(t,e,s){if(this.shape==="ellipsoid"){const{tiling:i,endCaps:n}=this,o=s===-1,r=o?i.getContentBounds(!0):i.getTileBounds(t,e,s,!0,!0),l=o?i.getContentBounds():i.getTileBounds(t,e,s,!1,!0);return n&&(r[3]===1&&(l[3]=Math.PI/2),r[1]===0&&(l[1]=-Math.PI/2)),{region:[...l,-1,1]}}else return super.createBoundingVolume(t,e,s)}createChild(...t){const e=super.createChild(...t),{shape:s,projection:i,tiling:n}=this;if(e&&s==="ellipsoid"){const o=e[N],r=e[O],l=e[H];if(o===-1)return e.geometricError=1e50,parent;const[c,a,h,T]=n.getTileBounds(r,l,o,!0),{tilePixelWidth:d,tilePixelHeight:f}=n.getLevel(o),u=(h-c)/d,p=(T-a)/f,[,M,S,P]=n.getTileBounds(r,l,o),B=M>0!=P>0?0:Math.min(Math.abs(M),Math.abs(P)),I=i.convertLatitudeToProjection(B),_=i.getLongitudeDerivativeAtProjection(c),C=i.getLatitudeDerivativeAtProjection(I),[j,v]=rt(this.tiles.ellipsoid,B,S),y=Math.max(u*_*j,p*C*v);e.geometricError=y}return e}}function ct(m){return/(:84|:crs84)$/i.test(m)}class ut extends Z{constructor(t={}){const{capabilities:e=null,layer:s=null,tileMatrixSet:i=null,style:n=null,url:o=null,dimensions:r={},...l}=t;super(l),this.capabilities=e,this.layer=s,this.tileMatrixSet=i,this.style=n,this.dimensions=r,this.url=o}getUrl(t,e,s){return this.url.replace(/{\s*TileMatrix\s*}/gi,s).replace(/{\s*TileCol\s*}/gi,t).replace(/{\s*TileRow\s*}/gi,e)}init(){const{tiling:t,dimensions:e,capabilities:s}=this;let{layer:i,tileMatrixSet:n,style:o,url:r}=this;i?typeof i=="string"&&(i=s.layers.find(a=>a.identifier===i)):i=s.layers[0],n?typeof n=="string"&&(n=i.tileMatrixSets.find(a=>a.identifier===n)):n=i.tileMatrixSets[0],o||(o=i.styles.find(a=>a.isDefault).identifier),r||(r=i.resourceUrls[0].template);const l=n.supportedCRS,c=l.includes("4326")||ct(l)?"EPSG:4326":"EPSG:3857";t.flipY=!0,t.setProjection(new F(c)),i.boundingBox!==null?t.setContentBounds(...i.boundingBox.bounds):t.setContentBounds(...t.projection.getBounds()),n.tileMatrices.forEach((a,h)=>{const{tileWidth:T,tileHeight:d,matrixWidth:f,matrixHeight:u}=a;t.setLevel(h,{tilePixelWidth:T,tilePixelHeight:d,tileCountX:f||t.projection.tileCountX*2**h,tileCountY:u||t.projection.tileCountY*2**h,tileBounds:a.bounds})}),r=r.replace(/{\s*TileMatrixSet\s*}/g,n.identifier).replace(/{\s*Style\s*}/g,o);for(const a in e)r=r.replace(new RegExp(`{\\s*${a}\\s*}`),e[a]);return i.dimensions.forEach(a=>{r=r.replace(new RegExp(`{\\s*${a.identifier}\\s*}`),a.defaultValue)}),this.url=r,Promise.resolve()}}class mt extends Z{constructor(t={}){const{url:e=null,layer:s=null,styles:i=null,contentBoundingBox:n=null,version:o="1.3.0",crs:r="EPSG:4326",format:l="image/png",transparent:c=!1,levels:a=18,tileDimension:h=256,...T}=t;super(T),this.url=e,this.layer=s,this.crs=r,this.format=l,this.tileDimension=h,this.styles=i,this.version=o,this.levels=a,this.transparent=c,this.contentBoundingBox=n}init(){const{tiling:t,levels:e,tileDimension:s,contentBoundingBox:i}=this;return t.setProjection(new F(this.crs)),t.flipY=!0,t.generateLevels(e,t.projection.tileCountX,t.projection.tileCountY,{tilePixelWidth:s,tilePixelHeight:s}),i!==null?t.setContentBounds(...i):t.setContentBounds(...t.projection.getBounds()),Promise.resolve()}normalizedToMercatorX(t){return g.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}normalizedToMercatorY(t){return g.mapLinear(t,0,1,-20037508342789244e-9,20037508342789244e-9)}getUrl(t,e,s){const{tiling:i,layer:n,crs:o,format:r,tileDimension:l,styles:c,version:a,transparent:h}=this,T=a==="1.1.1"?"SRS":"CRS";let d;if(o==="EPSG:3857"){const u=i.getTileBounds(t,e,s,!0,!1),p=this.normalizedToMercatorX(u[0]),M=this.normalizedToMercatorY(u[1]),S=this.normalizedToMercatorX(u[2]),P=this.normalizedToMercatorY(u[3]);d=[p,M,S,P]}else{const[u,p,M,S]=i.getTileBounds(t,e,s,!1,!1).map(P=>P*g.RAD2DEG);o==="EPSG:4326"?a==="1.1.1"?d=[u,p,M,S]:d=[p,u,S,M]:d=[u,p,M,S]}const f=new URLSearchParams({SERVICE:"WMS",REQUEST:"GetMap",VERSION:a,LAYERS:n,[T]:o,BBOX:d.join(","),WIDTH:l,HEIGHT:l,FORMAT:r,TRANSPARENT:h?"TRUE":"FALSE"});return c!=null&&f.set("STYLES",c),new URL("?"+f.toString(),this.url).toString()}}class Tt extends b{constructor(t={}){const{levels:e,tileDimension:s,url:i,...n}=t;super(n),this.name="XYZ_TILES_PLUGIN",this.imageSource=new nt({url:i,levels:e,tileDimension:s})}}class ft extends b{constructor(t={}){const{url:e,...s}=t;super(s),this.name="TMS_TILES_PLUGIN",this.imageSource=new ot({url:e})}}class Mt extends b{constructor(t={}){const{capabilities:e,layer:s,tileMatrixSet:i,style:n,dimensions:o,...r}=t;super(r),this.name="WTMS_TILES_PLUGIN",this.imageSource=new ut({capabilities:e,layer:s,tileMatrixSet:i,style:n,dimensions:o})}}class St extends b{constructor(t={}){const{url:e,layer:s,crs:i,format:n,tileDimension:o,styles:r,version:l,...c}=t;super(c),this.name="WMS_TILES_PLUGIN",this.imageSource=new mt({url:e,layer:s,crs:i,format:n,tileDimension:o,styles:r,version:l})}}export{ft as T,St as W,Tt as X,Mt as a};
//# sourceMappingURL=EPSGTilesPlugin-at5sGeAp.js.map
